<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Gym Routine</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Crect width='100%25' height='100%25' fill='%230b0f14'/%3E%3Ctext x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' font-size='92'%3E%F0%9F%8F%8B%EF%B8%8F%3C/text%3E%3C/svg%3E" />

  <style>
    :root { color-scheme: dark; --bg:#0b0f14; --card:#121a24; --muted:#95a3b8; --text:#eaf0ff; --accent:#5dd6c7; --danger:#ff5a7a; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--text); }
    header { padding:16px 16px 10px; position: sticky; top:0; background:linear-gradient(180deg, rgba(11,15,20,.98), rgba(11,15,20,.85)); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,.06);}
    .row { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap: wrap; }
    h1 { font-size:18px; margin:0; letter-spacing:.2px;}
    .sub { color:var(--muted); font-size:13px; margin-top:4px; }
    main { padding: 14px 16px 120px; }
    .card { background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:14px; padding:14px; margin:12px 0; }
    .card h2 { font-size:14px; margin:0 0 10px; color: #cfe2ff; letter-spacing:.2px; }
    .pill { font-size:12px; color:var(--muted); border:1px solid rgba(255,255,255,.1); padding:6px 10px; border-radius:999px; }
    .btn { border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06); color:var(--text); padding:8px 10px; border-radius:10px; font-weight:600; }
    .btn:active { transform: translateY(1px); }
    .ex { display:grid; grid-template-columns: 26px 1fr 120px; gap:10px; align-items:center; padding:10px 0; border-top:1px solid rgba(255,255,255,.06); }
    .ex:first-of-type { border-top:0; padding-top:2px; }
    .name { font-weight:700; font-size:14px; line-height:1.2; }
    .meta { color:var(--muted); font-size:12px; margin-top:2px; }
    input[type="checkbox"] { width:20px; height:20px; accent-color: var(--accent); }
    .w { width:100%; padding:10px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25); color:var(--text); font-size:14px; }
    .done .name { text-decoration: line-through; color: var(--muted); }
    .small { font-size:12px; color:var(--muted); }
    footer { position: fixed; left:0; right:0; bottom:0; padding:10px 16px; background:linear-gradient(180deg, rgba(11,15,20,0), rgba(11,15,20,.95) 35%, rgba(11,15,20,.98)); }
    .bar { display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .danger { border-color: rgba(255,90,122,.35); background: rgba(255,90,122,.1); }
    .ok { border-color: rgba(93,214,199,.35); background: rgba(93,214,199,.12); color: #cffff7; }
  </style>
</head>

<body>
<header>
  <div class="row">
    <div>
      <h1 id="title">Gym Routine</h1>
      <div class="sub" id="subtitle"></div>

      <div class="row" style="margin-top:10px;">
        <div class="pill" id="bwPill">Bodyweight: —</div>
        <button class="btn" id="bwBtn" type="button">Update BW</button>
        <div class="pill" id="logPill">Sheets: off</div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div class="pill" id="timerPill">Timer: 00:00</div>
        <button class="btn" id="timerStartBtn" type="button">Start</button>
        <button class="btn" id="timerEndBtn" type="button">End</button>
        <button class="btn ok" id="submitBtn" type="button">Submit workout</button>
      </div>
    </div>

    <div class="row" style="gap:8px;">
      <button class="btn" id="sheetsBtn" type="button">Sheets</button>
      <button class="btn danger" id="resetTodayBtn" type="button">Reset today</button>
    </div>
  </div>
</header>

<main id="app"></main>

<footer>
  <div class="bar">
    <div class="small" id="progress"></div>
    <div class="small" id="tip"></div>
  </div>
</footer>

<script>
/** -----------------------------
 *  Routine data (your plan)
 *  ----------------------------- */
const routine = {
  warmup: [
    { name: "Stairmaster", sets: "5 min", unit: "mins", placeholder: "mins" },
    { name: "Leg press (light)", sets: "2×15" },
    { name: "Shoulder machine (light)", sets: "2×15" },
    { name: "Sled", sets: "optional hard pushes" }
  ],
  days: {
    Monday: {
      title: "LEGS",
      exercises: [
        { name: "Leg Press", sets: "5×12" },
        { name: "Seated Leg Curl", sets: "4×15" },
        { name: "Leg Extension", sets: "4×15" },
        { name: "Standing Calf Raise Machine", sets: "5×20" },
        { name: "Hip Abductor Machine", sets: "3×20" }
      ],
      finisher: "Treadmill: 30 sec sprint / 30 sec walk ×10 (10 min)"
    },
    Tuesday: {
      title: "UPPER BODY (PUSH + PULL)",
      exercises: [
        { name: "Chest Press Machine", sets: "4×12" },
        { name: "Lat Pulldown", sets: "5×10" },
        { name: "Seated Row Machine", sets: "4×12" },
        { name: "Shoulder Press Machine", sets: "4×10" },
        { name: "Assisted Dips", sets: "3×max" }
      ],
      finisher: "Battle ropes or bike – 8 min hard"
    },
    Wednesday: {
      title: "LEGS + CONDITIONING",
      exercises: [
        { name: "Hack Squat or V-Squat", sets: "4×10" },
        { name: "Lying Leg Curl", sets: "4×12" },
        { name: "Walking Lunges (bodyweight or smith)", sets: "3×20" },
        { name: "Seated Calf Raise", sets: "4×25" }
      ],
      finisher: "StairMaster – 10 min nonstop"
    },
    Thursday: {
      title: "SHOULDERS + CORE",
      exercises: [
        { name: "Shoulder Press Machine", sets: "4×10" },
        { name: "Lateral Raise Machine", sets: "4×15" },
        { name: "Reverse Pec Deck", sets: "4×15" },
        { name: "Ab Crunch Machine", sets: "4×20" },
        { name: "Rotary Torso Machine", sets: "3×15/side" }
      ],
      finisher: "Rowing machine – 6×250 m"
    },
    Friday: {
      title: "CHEAT / RECOVERY DAY",
      exercises: [],
      finisher: "✔ Eat freely · ✔ Light movement only (walk/stretch/swim) · ❌ No lifting"
    },
    Saturday: {
      title: "FULL BODY",
      exercises: [
        { name: "Leg Press", sets: "4×15" },
        { name: "Chest Press", sets: "4×12" },
        { name: "Lat Pulldown", sets: "4×12" },
        { name: "Shoulder Press", sets: "3×12" },
        { name: "Back Extension Machine", sets: "3×15" }
      ],
      finisher: "Circuit ×3: 15 push-ups · 20 air squats · 30 sec plank"
    },
    Sunday: {
      title: "CARDIO + MOBILITY",
      exercises: [
        { name: "Bike or Treadmill", sets: "40 min" },
        { name: "Full-body stretching", sets: "20 min" }
      ],
      finisher: ""
    }
  }
};

/** -----------------------------
 *  Storage keys
 *  ----------------------------- */
const DEFAULT_UNIT = "kg";
const DEFAULT_SHEETS_URL = "https://script.google.com/macros/s/AKfycbx1oAqVYSfdf8ZoL919qoYmYsVl1m92-5KiivrDyfKblcb-BrXjQuQ5xtEYq-T_GQad/exec";
const LS = {
  weights: "gym.weights.v2",         // per exercise name -> last weight text
  checks: "gym.checks.v2",           // per date -> per exercise name -> boolean
  bodyweight: "gym.bodyweight.v2",   // string
  sheetsUrl: "gym.sheets_url.v2",    // Apps Script Web App URL
  logQueue: "gym.logqueue.v2",       // queued logs when offline
  sessions: "gym.sessions.v1",       // per date -> session summary
  timer: "gym.timer.v1"              // { start:number|null, end:number|null }
};

/** -----------------------------
 *  Helpers
 *  ----------------------------- */
function todayISO() {
  const d = new Date();
  const tz = d.getTimezoneOffset() * 60000;
  return new Date(d - tz).toISOString().slice(0,10);
}
function dayName() {
  return new Intl.DateTimeFormat(undefined, { weekday: "long" }).format(new Date());
}
function loadJSON(key, fallback) {
  try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
  catch { return fallback; }
}
function saveJSON(key, val) { localStorage.setItem(key, JSON.stringify(val)); }

function getUnit() { return DEFAULT_UNIT; }

function getBodyweight() { return localStorage.getItem(LS.bodyweight) || ""; }
function setBodyweight(v) { localStorage.setItem(LS.bodyweight, v); }

function getSheetsUrl() {
  const stored = localStorage.getItem(LS.sheetsUrl);
  return stored === null ? DEFAULT_SHEETS_URL : stored;
}
function setSheetsUrl(url) { localStorage.setItem(LS.sheetsUrl, url); }
if (localStorage.getItem(LS.sheetsUrl) === null) {
  setSheetsUrl(DEFAULT_SHEETS_URL);
}

function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escapeAttr(s){ return escapeHTML(s).replace(/`/g, "&#96;"); }

function loadTimerState() { return loadJSON(LS.timer, { start: null, end: null }); }
function saveTimerState(state) { saveJSON(LS.timer, state); }
function formatDuration(ms) {
  const total = Math.max(0, Math.floor(ms / 1000));
  const hrs = Math.floor(total / 3600);
  const mins = Math.floor((total % 3600) / 60);
  const secs = total % 60;
  if (hrs > 0) return `${String(hrs).padStart(2, "0")}:${String(mins).padStart(2, "0")}:${String(secs).padStart(2, "0")}`;
  return `${String(mins).padStart(2, "0")}:${String(secs).padStart(2, "0")}`;
}

/** -----------------------------
 *  Sheets logging (offline queue)
 *  ----------------------------- */
function enqueueLog(payload) {
  const q = loadJSON(LS.logQueue, []);
  q.push(payload);
  saveJSON(LS.logQueue, q);
}
async function tryFlushQueue() {
  const url = getSheetsUrl();
  if (!url) return;
  const q = loadJSON(LS.logQueue, []);
  if (!q.length) return;

  // Send in order; stop if one fails
  const remaining = [];
  for (const item of q) {
    const ok = await sendToSheets(url, item);
    if (!ok) { remaining.push(item); break; }
  }
  // keep unsent items + rest
  const idxSent = q.length - remaining.length;
  const rest = q.slice(idxSent + (remaining.length ? 1 : 0));
  const merged = remaining.concat(rest);
  saveJSON(LS.logQueue, merged);
}

async function sendToSheets(url, payload) {
  const body = JSON.stringify(payload);
  try {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body
    });
    return res.ok;
  } catch {
    try {
      await fetch(url, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body
      });
      return true;
    } catch {
      return false;
    }
  }
}

async function logToSheets(payload) {
  const url = getSheetsUrl();
  if (!url) return;
  // Always queue first (so nothing gets lost); then try to flush
  enqueueLog(payload);
  await tryFlushQueue();
}

/** -----------------------------
 *  UI Elements
 *  ----------------------------- */
const appEl = document.getElementById("app");
const subtitleEl = document.getElementById("subtitle");
const resetTodayBtn = document.getElementById("resetTodayBtn");
const progressEl = document.getElementById("progress");
const tipEl = document.getElementById("tip");

const bwPill = document.getElementById("bwPill");
const bwBtn  = document.getElementById("bwBtn");
const logPill = document.getElementById("logPill");
const sheetsBtn = document.getElementById("sheetsBtn");
const timerPill = document.getElementById("timerPill");
const timerStartBtn = document.getElementById("timerStartBtn");
const timerEndBtn = document.getElementById("timerEndBtn");
const submitBtn = document.getElementById("submitBtn");

/** -----------------------------
 *  Render
 *  ----------------------------- */
function render() {
  const day = dayName();
  const date = todayISO();
  const plan = routine.days[day] || routine.days.Monday;

  const unit = getUnit();

  const bw = getBodyweight();
  bwPill.textContent = `Bodyweight: ${bw ? (bw + " " + unit) : "—"}`;

  const sheetsUrl = getSheetsUrl();
  const queued = loadJSON(LS.logQueue, []).length;
  if (!sheetsUrl) {
    logPill.textContent = "Sheets: off";
    logPill.className = "pill";
  } else if (queued > 0) {
    logPill.textContent = `Sheets: on · queued ${queued}`;
    logPill.className = "pill danger";
  } else {
    logPill.textContent = "Sheets: on";
    logPill.className = "pill ok";
  }

  subtitleEl.textContent = `${day} · ${date} · ${plan.title}`;

  const weights = loadJSON(LS.weights, {});
  const checksAll = loadJSON(LS.checks, {});
  const checks = checksAll[date] || {};

  const warm = routine.warmup.map(x => ({...x, section:"Warm-up"}));
  const main = plan.exercises.map(x => ({...x, section:"Main"}));
  const fin = plan.finisher ? [{ name: "Finisher", sets: plan.finisher, section:"Finisher", isFinisher:true, noWeight:true, unit: "" }] : [];
  const allExercisesToday = [...warm, ...main, ...fin];

  const totalCheckable = allExercisesToday.length;
  const doneCount = allExercisesToday.filter(x => checks[x.name]).length;

  progressEl.textContent = `Done: ${doneCount}/${totalCheckable}`;
  tipEl.textContent = day === "Friday" ? "Recover hard." : "Rest 45–60s. Go fast.";

  const html = [];
  html.push(card("DAILY WARM-UP (10 min)", routine.warmup, weights, checks, "Warm-up"));
  html.push(card(`${day} — ${plan.title}`, plan.exercises, weights, checks, "Workout", plan.finisher));

  if (day === "Friday") {
    html.push(`
      <div class="card">
        <h2>FRIDAY — CHEAT / RECOVERY</h2>
        <div class="small">${escapeHTML(routine.days.Friday.finisher)}</div>
      </div>
    `);
  }

  appEl.innerHTML = html.join("");
  wireInputs(date, day);
  renderTimer();
  ensureTimerInterval();
}

function card(title, exercises, weights, checks, sectionLabel, finisherText = "") {
  const rows = [];
  (exercises || []).forEach((ex) => rows.push(exerciseRow(ex, weights, checks)));
  if (finisherText) {
    rows.push(exerciseRow({ name: "Finisher", sets: finisherText, noWeight: true, unit: "" }, weights, checks));
  }

  return `
    <div class="card" data-section="${escapeAttr(sectionLabel)}">
      <h2>${escapeHTML(title)}</h2>
      ${rows.join("") || `<div class="small">No exercises today.</div>`}
    </div>
  `;
}

function exerciseRow(ex, weights, checks) {
  const key = ex.name;
  const unitLabel = Object.prototype.hasOwnProperty.call(ex, "unit") ? ex.unit : DEFAULT_UNIT;
  const last = weights[key] ?? "";
  const checked = !!checks[key];
  const metaParts = [];
  if (ex.sets) metaParts.push(escapeHTML(ex.sets));
  if (!ex.noWeight && last) {
    const unitText = unitLabel ? ` ${escapeHTML(String(unitLabel))}` : "";
    metaParts.push(`last: ${escapeHTML(String(last))}${unitText}`);
  }
  const meta = metaParts.join(" · ");
  const placeholder = ex.placeholder || (unitLabel === "mins" ? "mins" : "weight");
  const weightInput = ex.noWeight
    ? `<div></div>`
    : `<input class="w" inputmode="decimal" placeholder="${escapeAttr(placeholder)}" value="${escapeAttr(last)}" data-kind="weight" data-ex="${escapeAttr(key)}" data-sets="${escapeAttr(ex.sets || "")}" data-unit="${escapeAttr(unitLabel)}"/>`;

  return `
    <div class="ex ${checked ? "done" : ""}">
      <input type="checkbox" data-kind="check" data-ex="${escapeAttr(key)}" data-unit="${escapeAttr(unitLabel)}" data-sets="${escapeAttr(ex.sets || "")}" ${checked ? "checked":""}/>
      <div>
        <div class="name">${escapeHTML(ex.name)}</div>
        <div class="meta">${meta || ""}</div>
      </div>
      ${weightInput}
    </div>
  `;
}

function getDataUnit(el) {
  const val = el.getAttribute("data-unit");
  return val === null ? getUnit() : val;
}

function wireInputs(date, day) {
  const weights = loadJSON(LS.weights, {});
  const checksAll = loadJSON(LS.checks, {});
  const checks = checksAll[date] || {};

  document.querySelectorAll('[data-kind="weight"]').forEach(input => {
    input.addEventListener("input", (e) => {
      const ex = e.target.getAttribute("data-ex");
      const val = (e.target.value || "").trim();
      weights[ex] = val;
      saveJSON(LS.weights, weights);
    });
    input.addEventListener("change", async (e) => {
      const ex = e.target.getAttribute("data-ex");
      const sets = e.target.getAttribute("data-sets") || "";
      const unit = getDataUnit(e.target);
      const val = (e.target.value || "").trim();

      weights[ex] = val;
      saveJSON(LS.weights, weights);

      await logToSheets({
        type: "weight_update",
        timestamp: new Date().toISOString(),
        date,
        day,
        section: "Workout",
        exercise: ex,
        sets,
        weight: val,
        unit,
        checked: null,
        bodyweight: getBodyweight() || ""
      });

      render();
    });
  });

  document.querySelectorAll('[data-kind="check"]').forEach(box => {
    box.addEventListener("change", async (e) => {
      const ex = e.target.getAttribute("data-ex");
      const sets = e.target.getAttribute("data-sets") || "";
      const unit = getDataUnit(e.target);
      const checked = e.target.checked;

      checks[ex] = checked;
      checksAll[date] = checks;
      saveJSON(LS.checks, checksAll);

      await logToSheets({
        type: "check",
        timestamp: new Date().toISOString(),
        date,
        day,
        section: "Workout",
        exercise: ex,
        sets,
        weight: loadJSON(LS.weights, {})[ex] || "",
        unit,
        checked,
        bodyweight: getBodyweight() || ""
      });

      render();
    });
  });
}

/** -----------------------------
 *  Session submit + timer
 *  ----------------------------- */
let timerInterval = null;

function renderTimer() {
  const state = loadTimerState();
  const elapsed = state.start ? (state.end || Date.now()) - state.start : 0;
  timerPill.textContent = `Timer: ${formatDuration(elapsed)}`;
  timerStartBtn.disabled = !!state.start && !state.end;
  timerEndBtn.disabled = !state.start || !!state.end;
}

function ensureTimerInterval() {
  if (timerInterval) clearInterval(timerInterval);
  const state = loadTimerState();
  if (state.start && !state.end) {
    timerInterval = setInterval(renderTimer, 1000);
  }
}

async function startTimer() {
  const now = Date.now();
  saveTimerState({ start: now, end: null });
  renderTimer();
  ensureTimerInterval();
  await logToSheets({
    type: "timer_start",
    timestamp: new Date().toISOString(),
    date: todayISO(),
    day: dayName(),
    section: "Timer",
    exercise: "",
    sets: "",
    weight: "",
    unit: "",
    checked: null,
    bodyweight: getBodyweight() || "",
    start: new Date(now).toISOString()
  });
}

async function endTimer() {
  const state = loadTimerState();
  if (!state.start || state.end) return;
  const end = Date.now();
  saveTimerState({ start: state.start, end });
  renderTimer();
  ensureTimerInterval();
  await logToSheets({
    type: "timer_end",
    timestamp: new Date().toISOString(),
    date: todayISO(),
    day: dayName(),
    section: "Timer",
    exercise: "",
    sets: "",
    weight: "",
    unit: "",
    checked: null,
    bodyweight: getBodyweight() || "",
    start: new Date(state.start).toISOString(),
    end: new Date(end).toISOString(),
    elapsed_ms: end - state.start
  });
}

function buildSessionPayload(date, day) {
  const plan = routine.days[day] || routine.days.Monday;
  const warm = routine.warmup.map(x => ({...x, section:"Warm-up"}));
  const main = plan.exercises.map(x => ({...x, section:"Workout"}));
  const fin = plan.finisher ? [{ name: "Finisher", sets: plan.finisher, section: "Finisher", noWeight: true, unit: "" }] : [];
  const all = [...warm, ...main, ...fin];

  const weights = loadJSON(LS.weights, {});
  const checksAll = loadJSON(LS.checks, {});
  const checks = checksAll[date] || {};
  const timer = loadTimerState();

  const items = all.map((ex) => ({
    name: ex.name,
    sets: ex.sets || "",
    section: ex.section || "",
    weight: weights[ex.name] || "",
    unit: ex.noWeight ? "" : (ex.unit || DEFAULT_UNIT),
    checked: !!checks[ex.name]
  }));

  return {
    type: "session_submit",
    timestamp: new Date().toISOString(),
    date,
    day,
    title: plan.title,
    bodyweight: getBodyweight() || "",
    timer,
    items
  };
}

async function submitSession() {
  const date = todayISO();
  const day = dayName();
  const payload = buildSessionPayload(date, day);
  const sessions = loadJSON(LS.sessions, {});
  sessions[date] = payload;
  saveJSON(LS.sessions, sessions);
  await logToSheets(payload);
  alert("Workout submitted. (If offline, it will queue and auto-send later.)");
}

/** -----------------------------
 *  Buttons
 *  ----------------------------- */
resetTodayBtn.addEventListener("click", () => {
  const date = todayISO();
  const checksAll = loadJSON(LS.checks, {});
  delete checksAll[date];
  saveJSON(LS.checks, checksAll);
  render();
});

timerStartBtn.addEventListener("click", () => startTimer());
timerEndBtn.addEventListener("click", () => endTimer());
submitBtn.addEventListener("click", () => submitSession());

bwBtn.addEventListener("click", async () => {
  const unit = getUnit();
  const current = getBodyweight();
  const v = prompt(`Enter current bodyweight (${unit})`, current || "");
  if (v === null) return;
  const val = String(v).trim();
  setBodyweight(val);

  await logToSheets({
    type: "bodyweight",
    timestamp: new Date().toISOString(),
    date: todayISO(),
    day: dayName(),
    section: "Bodyweight",
    exercise: "",
    sets: "",
    weight: "",
    unit: getUnit(),
    checked: null,
    bodyweight: val
  });

  render();
});

sheetsBtn.addEventListener("click", () => {
  const current = getSheetsUrl();
  const v = prompt(
    "Paste your Google Apps Script Web App URL (leave blank to disable):",
    current || ""
  );
  if (v === null) return;
  const val = String(v).trim();
  setSheetsUrl(val);
  render();
  alert(val ? "Sheets logging enabled. (If offline, logs queue and auto-send later.)" : "Sheets logging disabled.");
});

/** -----------------------------
 *  Service worker
 *  ----------------------------- */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js"));
}

window.addEventListener("online", () => tryFlushQueue().then(render));
window.addEventListener("offline", render);

render();
tryFlushQueue().then(render);
</script>
</body>
</html>
